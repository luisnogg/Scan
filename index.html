<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScanBill Web</title>
    
    <!-- 1. Tailwind CSS für das Design laden -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React und ReactDOM laden -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel laden (damit der Code im Browser läuft) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Verstecke Scrollbars für cleaneren Look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <!-- Hier beginnt die App-Logik -->
    <script type="text/babel" data-type="module">
        // Importiere Firebase direkt aus dem Internet (CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // ---------------------------------------------------------
        // ACHTUNG: HIER DEINE EIGENEN FIREBASE-DATEN EINFÜGEN!
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "HIER_API_KEY_EINFÜGEN",
            authDomain: "dein-projekt.firebaseapp.com",
            projectId: "dein-projekt",
            storageBucket: "dein-projekt.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        // ---------------------------------------------------------

        // App starten (Fehler abfangen, falls Config fehlt)
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Fehler: Hast du die Config eingetragen?", e);
        }

        const React = window.React;
        const { useState, useEffect, useRef } = React;

        // --- ICONS (Damit sie ohne Extra-Installation funktionieren) ---
        const Icon = ({ path, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {path}
            </svg>
        );

        const Icons = {
            Camera: (p) => <Icon {...p} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            X: (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Receipt: (p) => <Icon {...p} path={<><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><line x1="14" y1="8" x2="8" y2="8"/><line x1="14" y1="12" x2="8" y2="12"/><line x1="14" y1="16" x2="8" y2="16"/></>} />,
            PieChart: (p) => <Icon {...p} path={<><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            Calendar: (p) => <Icon {...p} path={<><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />
        };

        // --- HAUPTKOMPONENTE ---
        function App() {
            const [user, setUser] = useState(null);
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [scanStep, setScanStep] = useState('choice'); // 'choice', 'camera', 'form'
            
            const [bills, setBills] = useState([]);
            const [currentPhoto, setCurrentPhoto] = useState(null);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            // Formular State
            const [formData, setFormData] = useState({
                vendor: '',
                amount: '',
                date: new Date().toISOString().split('T')[0],
                category: 'Sonstiges'
            });

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);

            // Auth & Data Loading
            useEffect(() => {
                if(!auth) return; 

                // Anonym einloggen
                signInAnonymously(auth).catch(err => console.error("Login Fehler:", err));
                
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;

                const q = query(collection(db, 'users', user.uid, 'bills'));
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const billsData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    billsData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    setBills(billsData);
                }, (error) => {
                    console.error("Fehler beim Laden:", error);
                });

                return () => unsubscribe();
            }, [user]);

            // Kamera
            const startCamera = async () => {
                setScanStep('camera');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error("Kamera Zugriff verweigert:", err);
                    alert("Kamerazugriff nicht möglich. Bitte Datei-Upload nutzen.");
                    setScanStep('choice');
                }
            };

            const stopCamera = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                }
            };

            const capturePhoto = () => {
                if (videoRef.current && canvasRef.current) {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const photoDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    setCurrentPhoto(photoDataUrl);
                    stopCamera();
                    setScanStep('form');
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setCurrentPhoto(reader.result);
                        setScanStep('form');
                    };
                    reader.readAsDataURL(file);
                }
            };

            // Reset & Close
            const resetForm = () => {
                setFormData({
                    vendor: '',
                    amount: '',
                    date: new Date().toISOString().split('T')[0],
                    category: 'Sonstiges'
                });
                setCurrentPhoto(null);
                setScanStep('choice');
                stopCamera();
            };

            const closeAddModal = () => {
                resetForm();
                setIsAddModalOpen(false);
            };

            // Speichern
            const saveBill = async () => {
                if (!formData.vendor || !formData.amount) {
                    alert("Bitte Händler und Betrag eingeben.");
                    return;
                }

                try {
                    setLoading(true);
                    await addDoc(collection(db, 'users', user.uid, 'bills'), {
                        vendor: formData.vendor,
                        amount: parseFloat(formData.amount),
                        date: formData.date,
                        category: formData.category,
                        createdAt: new Date().toISOString(),
                        hasImage: !!currentPhoto
                    });
                    closeAddModal();
                } catch (error) {
                    console.error("Fehler beim Speichern:", error);
                    alert("Fehler beim Speichern. Check die Config!");
                } finally {
                    setLoading(false);
                }
            };

            const deleteBill = async (id) => {
                if (window.confirm("Wirklich löschen?")) {
                    await deleteDoc(doc(db, 'users', user.uid, 'bills', id));
                }
            };

            // Berechnungen
            const filteredBills = bills.filter(bill => 
                bill.vendor.toLowerCase().includes(searchTerm.toLowerCase()) ||
                bill.category.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const totalAmount = bills.reduce((sum, bill) => sum + (parseFloat(bill.amount) || 0), 0);
            const currentMonthAmount = bills
                .filter(b => new Date(b.date).getMonth() === new Date().getMonth())
                .reduce((sum, bill) => sum + (parseFloat(bill.amount) || 0), 0);

            // --- RENDERING ---
            if (!auth) return <div className="p-10 text-center text-red-500 font-bold">FEHLER: Bitte Firebase Config in index.html eintragen!</div>;

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900 pb-20">
                    {/* Navigation */}
                    <nav className="bg-white border-b border-gray-200 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center gap-3">
                                    <div className="bg-indigo-600 p-2 rounded-lg">
                                        <Icons.Receipt className="w-6 h-6 text-white" />
                                    </div>
                                    <span className="font-bold text-xl tracking-tight text-gray-900">ScanBill<span className="text-indigo-600">Web</span></span>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div className="hidden md:flex text-sm text-gray-500 gap-6 mr-4">
                                        <span className="hover:text-indigo-600 cursor-pointer transition">Dashboard</span>
                                    </div>
                                    <button 
                                        onClick={() => { setIsAddModalOpen(true); setScanStep('choice'); }}
                                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition shadow-sm"
                                    >
                                        <Icons.Plus className="w-4 h-4" />
                                        <span className="hidden sm:inline">Neue Rechnung</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-sm font-medium text-gray-500">Gesamtausgaben</p>
                                        <h3 className="text-3xl font-bold text-gray-900 mt-2">{totalAmount.toFixed(2).replace('.', ',')} €</h3>
                                    </div>
                                    <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><Icons.PieChart className="w-6 h-6" /></div>
                                </div>
                            </div>
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-sm font-medium text-gray-500">Dieser Monat</p>
                                        <h3 className="text-3xl font-bold text-gray-900 mt-2">{currentMonthAmount.toFixed(2).replace('.', ',')} €</h3>
                                    </div>
                                    <div className="p-2 bg-green-50 text-green-600 rounded-lg"><Icons.Calendar className="w-6 h-6" /></div>
                                </div>
                            </div>
                            <div className="bg-gradient-to-br from-indigo-600 to-purple-700 p-6 rounded-2xl shadow-lg text-white">
                                <h3 className="text-lg font-semibold mb-2">Scannen & Erfassen</h3>
                                <p className="text-indigo-100 text-sm mb-4">Erfasse deine Ausgaben jetzt noch schneller.</p>
                                <button onClick={() => { setIsAddModalOpen(true); setScanStep('choice'); }} className="w-full bg-white/10 hover:bg-white/20 border border-white/20 text-white py-2 rounded-lg text-sm font-medium transition backdrop-blur-sm">Starten</button>
                            </div>
                        </div>

                        {/* Search */}
                        <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <div className="relative w-full sm:w-96">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <Icons.Search className="h-5 w-5 text-gray-400" />
                                </div>
                                <input type="text" placeholder="Suche..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="block w-full pl-10 pr-3 py-2.5 border border-gray-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                            </div>
                        </div>

                        {/* Table */}
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                            {filteredBills.length === 0 ? (
                                <div className="text-center py-16 px-4">
                                    <div className="bg-gray-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Search className="w-8 h-8 text-gray-400" /></div>
                                    <p className="text-gray-500">Keine Belege gefunden.</p>
                                </div>
                            ) : (
                                <>
                                    <div className="hidden md:block overflow-x-auto">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Datum</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Händler</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Kategorie</th>
                                                    <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Betrag</th>
                                                    <th className="px-6 py-3"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {filteredBills.map((bill) => (
                                                    <tr key={bill.id} className="hover:bg-gray-50">
                                                        <td className="px-6 py-4 text-sm text-gray-500">{new Date(bill.date).toLocaleDateString('de-DE')}</td>
                                                        <td className="px-6 py-4 text-sm font-medium text-gray-900 flex items-center gap-2">
                                                            {bill.vendor}
                                                            {bill.hasImage && <Icons.Camera className="w-3 h-3 text-gray-400" />}
                                                        </td>
                                                        <td className="px-6 py-4"><span className="px-2.5 py-0.5 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">{bill.category}</span></td>
                                                        <td className="px-6 py-4 text-sm text-gray-900 text-right font-medium">{bill.amount.toFixed(2).replace('.', ',')} €</td>
                                                        <td className="px-6 py-4 text-right">
                                                            <button onClick={() => deleteBill(bill.id)} className="text-gray-400 hover:text-red-600"><Icons.Trash2 className="w-5 h-5" /></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="md:hidden divide-y divide-gray-100">
                                        {filteredBills.map((bill) => (
                                            <div key={bill.id} className="p-4 flex justify-between items-center">
                                                <div className="flex gap-3">
                                                    <div className="bg-gray-100 p-2 rounded-lg"><Icons.FileText className="w-5 h-5 text-gray-600" /></div>
                                                    <div>
                                                        <p className="font-semibold text-sm">{bill.vendor}</p>
                                                        <p className="text-xs text-gray-500">{new Date(bill.date).toLocaleDateString()} • {bill.category}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-bold text-sm">{bill.amount.toFixed(2)} €</p>
                                                    <button onClick={() => deleteBill(bill.id)} className="text-xs text-red-500 mt-1">Löschen</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            )}
                        </div>
                    </main>

                    {/* MODAL */}
                    {isAddModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto flex flex-col">
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center sticky top-0 bg-white z-10">
                                    <h2 className="text-lg font-bold">Neuer Beleg</h2>
                                    <button onClick={closeAddModal} className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"><Icons.X className="w-5 h-5" /></button>
                                </div>
                                <div className="p-6">
                                    {scanStep === 'choice' && (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <button onClick={startCamera} className="p-8 bg-indigo-50 border-2 border-indigo-100 rounded-xl hover:bg-indigo-100 flex flex-col items-center">
                                                <div className="bg-white p-4 rounded-full shadow-sm mb-4"><Icons.Camera className="w-8 h-8 text-indigo-600" /></div>
                                                <span className="font-semibold text-indigo-900">Kamera</span>
                                            </button>
                                            <label className="p-8 bg-gray-50 border-2 border-gray-100 rounded-xl hover:bg-gray-100 cursor-pointer flex flex-col items-center">
                                                <input type="file" accept="image/*" className="hidden" onChange={handleFileUpload} />
                                                <div className="bg-white p-4 rounded-full shadow-sm mb-4"><Icons.Upload className="w-8 h-8 text-gray-600" /></div>
                                                <span className="font-semibold text-gray-900">Upload</span>
                                            </label>
                                            <button onClick={() => setScanStep('form')} className="col-span-1 sm:col-span-2 text-sm text-gray-500 hover:text-indigo-600 underline text-center mt-2">Manuell eingeben</button>
                                        </div>
                                    )}
                                    {scanStep === 'camera' && (
                                        <div className="rounded-xl overflow-hidden bg-black relative aspect-[3/4]">
                                            <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
                                            <canvas ref={canvasRef} className="hidden" />
                                            <div className="absolute bottom-6 w-full flex justify-center">
                                                <button onClick={capturePhoto} className="w-16 h-16 rounded-full border-4 border-white bg-white/20"></button>
                                            </div>
                                        </div>
                                    )}
                                    {scanStep === 'form' && (
                                        <div className="space-y-4">
                                            {currentPhoto && (
                                                <div className="h-40 bg-gray-100 rounded-xl overflow-hidden border relative group">
                                                    <img src={currentPhoto} className="w-full h-full object-contain" />
                                                    <button onClick={() => {setCurrentPhoto(null); setScanStep('choice');}} className="absolute top-2 right-2 bg-black/50 text-white p-1.5 rounded"><Icons.Trash2 className="w-4 h-4" /></button>
                                                </div>
                                            )}
                                            <input type="text" placeholder="Händler (z.B. REWE)" value={formData.vendor} onChange={e => setFormData({...formData, vendor: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-lg" autoFocus />
                                            <div className="grid grid-cols-2 gap-4">
                                                <input type="number" step="0.01" placeholder="0.00" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-lg" />
                                                <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-lg" />
                                            </div>
                                            <select value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})} className="w-full p-3 bg-gray-50 border rounded-lg">
                                                <option>Lebensmittel</option><option>Transport</option><option>Wohnen</option><option>Elektronik</option><option>Freizeit</option><option>Sonstiges</option>
                                            </select>
                                            <button onClick={saveBill} disabled={loading} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 flex justify-center items-center gap-2">
                                                {loading ? "..." : <><Icons.Save className="w-5 h-5" /> Speichern</>}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
