<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScanBill Buchhaltung</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tesseract.js (OCR) -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #4f46e5;
            box-shadow: 0 0 4px #4f46e5;
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const React = window.React;
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {path}
            </svg>
        );

        const Icons = {
            Camera: (p) => <Icon {...p} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Trash: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Check: (p) => <Icon {...p} path={<><polyline points="20 6 9 17 4 12"/></>} />,
            X: (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            List: (p) => <Icon {...p} path={<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>} />
        };

        function App() {
            // Views: 'list' (Dashboard), 'camera', 'processing', 'edit'
            const [view, setView] = useState('list');
            const [bills, setBills] = useState([]);
            
            // Temporary Scan Data
            const [tempImage, setTempImage] = useState(null);
            const [progress, setProgress] = useState(0);
            const [statusText, setStatusText] = useState('');
            
            // Edit Form Data
            const [formData, setFormData] = useState({
                date: '',
                vendor: '',
                amount: '',
                category: 'Sonstiges',
                taxRate: 19
            });

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);

            // --- LOCAL STORAGE ---
            useEffect(() => {
                const saved = localStorage.getItem('scanbill_data');
                if (saved) {
                    setBills(JSON.parse(saved));
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('scanbill_data', JSON.stringify(bills));
            }, [bills]);

            // --- CAMERA & UPLOAD ---
            const startCamera = async () => {
                setView('camera');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    streamRef.current = stream;
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) {
                    alert("Kamera nicht verfügbar. Bitte Datei-Upload nutzen.");
                    setView('list');
                }
            };

            const stopCamera = () => {
                if (streamRef.current) streamRef.current.getTracks().forEach(t => t.stop());
            };

            const capturePhoto = () => {
                if (videoRef.current && canvasRef.current) {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    setTempImage(dataUrl);
                    stopCamera();
                    processImage(dataUrl);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setTempImage(reader.result);
                        processImage(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // --- INTELLIGENT OCR ---
            const processImage = async (imageSrc) => {
                setView('processing');
                setProgress(0);
                
                try {
                    const result = await Tesseract.recognize(imageSrc, 'deu', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                setProgress(Math.round(m.progress * 100));
                                setStatusText(`Textanalyse: ${Math.round(m.progress * 100)}%`);
                            } else {
                                setStatusText("Bildvorbereitung...");
                            }
                        }
                    });

                    const text = result.data.text;
                    console.log("OCR Raw:", text);
                    
                    // 1. Suche Betrag (Größte Zahl mit 2 Dezimalstellen)
                    const priceRegex = /(\d+[.,]\d{2})/g;
                    const priceMatches = text.match(priceRegex);
                    let detectedAmount = '';
                    if (priceMatches) {
                        const numbers = priceMatches.map(m => parseFloat(m.replace(',', '.')));
                        const maxAmount = Math.max(...numbers);
                        detectedAmount = maxAmount.toFixed(2); // . für Input field
                    }

                    // 2. Suche Datum (DD.MM.YYYY oder DD.MM.YY)
                    const dateRegex = /(\d{2})\.(\d{2})\.(\d{2,4})/;
                    const dateMatch = text.match(dateRegex);
                    let detectedDate = new Date().toISOString().split('T')[0];
                    if (dateMatch) {
                        const year = dateMatch[3].length === 2 ? '20' + dateMatch[3] : dateMatch[3];
                        detectedDate = `${year}-${dateMatch[2]}-${dateMatch[1]}`;
                    }

                    // 3. Suche Händler (Einfache Keywords)
                    const vendors = ['REWE', 'ALDI', 'LIDL', 'SHELL', 'ARAL', 'DM', 'ROSSMANN', 'EDEKA', 'MEDIA MARKT', 'SATURN', 'AMAZON', 'DB', 'UBER'];
                    const upperText = text.toUpperCase();
                    let detectedVendor = '';
                    for (let v of vendors) {
                        if (upperText.includes(v)) {
                            detectedVendor = v;
                            break;
                        }
                    }

                    setFormData({
                        date: detectedDate,
                        vendor: detectedVendor,
                        amount: detectedAmount,
                        category: 'Sonstiges',
                        taxRate: 19
                    });
                    
                    setView('edit');

                } catch (e) {
                    console.error(e);
                    alert("Fehler bei der Analyse.");
                    setView('list');
                }
            };

            // --- DATA MANAGEMENT ---
            const saveEntry = () => {
                if (!formData.amount || !formData.vendor) {
                    alert("Bitte mindestens Händler und Betrag angeben.");
                    return;
                }
                
                const newBill = {
                    id: Date.now(),
                    ...formData,
                    amount: parseFloat(formData.amount),
                    image: tempImage // Bild speichern (Achtung: LocalStorage Limit!)
                    // Für echte Produktion würde man das Bild verkleinern oder weglassen
                };

                // Bild weglassen für Performance, wenn Liste lang wird
                const { image, ...billDataOnly } = newBill; 

                setBills([billDataOnly, ...bills]);
                setTempImage(null);
                setView('list');
            };

            const deleteEntry = (id) => {
                if(confirm("Eintrag löschen?")) {
                    setBills(bills.filter(b => b.id !== id));
                }
            };

            const downloadCSV = () => {
                if (bills.length === 0) return alert("Keine Daten zum Exportieren.");

                // CSV Header
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Datum;Händler;Kategorie;Brutto;Steuer_Satz;Steuer_Betrag;Netto\n";

                bills.forEach(bill => {
                    const brutto = bill.amount;
                    // Steuer rausrechnen: Brutto / (1 + satz/100) * (satz/100)
                    const taxAmount = (brutto / (1 + bill.taxRate/100) * (bill.taxRate/100)).toFixed(2);
                    const netto = (brutto - taxAmount).toFixed(2);
                    const dateDe = new Date(bill.date).toLocaleDateString('de-DE');

                    const row = `${dateDe};${bill.vendor};${bill.category};${brutto.toFixed(2).replace('.',',')};${bill.taxRate}%;${taxAmount.replace('.',',')};${netto.replace('.',',')}`;
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `buchhaltung_export_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- UI ---
            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900 pb-20">
                    
                    {/* Header */}
                    <div className="bg-white border-b border-gray-200 sticky top-0 z-10 px-4 py-3 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="bg-indigo-600 text-white p-1.5 rounded-lg">
                                <Icons.List className="w-5 h-5" />
                            </div>
                            <span className="font-bold text-lg">Buchhaltung<span className="text-indigo-600">Scan</span></span>
                        </div>
                        {view === 'list' && (
                             <div className="flex gap-2">
                                <button onClick={downloadCSV} className="p-2 text-gray-600 hover:text-indigo-600 bg-gray-50 hover:bg-indigo-50 rounded-lg transition" title="CSV Export">
                                    <Icons.Download className="w-5 h-5" />
                                </button>
                            </div>
                        )}
                        {view !== 'list' && (
                            <button onClick={() => { stopCamera(); setView('list'); }} className="p-2 text-gray-500 bg-gray-100 rounded-full">
                                <Icons.X className="w-5 h-5" />
                            </button>
                        )}
                    </div>

                    <div className="max-w-2xl mx-auto p-4">

                        {/* VIEW: LIST (DASHBOARD) */}
                        {view === 'list' && (
                            <div className="space-y-6 animate-in fade-in duration-300">
                                
                                {/* Stats Card */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-indigo-600 rounded-xl p-4 text-white shadow-lg shadow-indigo-200">
                                        <p className="text-indigo-100 text-xs uppercase font-semibold">Gesamtausgaben</p>
                                        <p className="text-2xl font-bold mt-1">
                                            {bills.reduce((sum, b) => sum + b.amount, 0).toFixed(2).replace('.', ',')} €
                                        </p>
                                    </div>
                                    <button onClick={startCamera} className="bg-white border-2 border-indigo-100 rounded-xl p-4 text-indigo-600 hover:bg-indigo-50 hover:border-indigo-300 transition flex flex-col items-center justify-center gap-1 shadow-sm">
                                        <Icons.Camera className="w-6 h-6" />
                                        <span className="font-semibold text-sm">Beleg scannen</span>
                                    </button>
                                </div>

                                <div className="flex justify-between items-center">
                                    <h2 className="font-bold text-gray-700">Deine Buchungen ({bills.length})</h2>
                                    <label className="text-sm text-indigo-600 font-medium cursor-pointer hover:underline flex items-center gap-1">
                                        <input type="file" accept="image/*" className="hidden" onChange={handleFileUpload} />
                                        <Icons.Upload className="w-4 h-4" /> Upload
                                    </label>
                                </div>

                                {/* List */}
                                <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                                    {bills.length === 0 ? (
                                        <div className="p-8 text-center text-gray-400">
                                            Noch keine Einträge. Starte den Scan!
                                        </div>
                                    ) : (
                                        <div className="divide-y divide-gray-100">
                                            {bills.map(bill => (
                                                <div key={bill.id} className="p-4 flex justify-between items-center hover:bg-gray-50 transition">
                                                    <div>
                                                        <div className="font-bold text-gray-900">{bill.vendor || "Unbekannt"}</div>
                                                        <div className="text-xs text-gray-500 flex gap-2">
                                                            <span>{new Date(bill.date).toLocaleDateString('de-DE')}</span>
                                                            <span className="bg-gray-100 px-1.5 rounded text-gray-600">{bill.category}</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-gray-900">{bill.amount.toFixed(2).replace('.', ',')} €</div>
                                                        <button onClick={() => deleteEntry(bill.id)} className="text-xs text-red-400 hover:text-red-600 mt-1">Löschen</button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* VIEW: CAMERA */}
                        {view === 'camera' && (
                            <div className="fixed inset-0 bg-black flex flex-col z-50">
                                <video ref={videoRef} autoPlay playsInline className="flex-1 w-full object-cover" />
                                <canvas ref={canvasRef} className="hidden" />
                                <div className="p-6 bg-black/80 flex justify-center gap-8 pb-10">
                                    <button onClick={() => {stopCamera(); setView('list');}} className="p-4 rounded-full bg-gray-800 text-white"><Icons.X className="w-6 h-6" /></button>
                                    <button onClick={capturePhoto} className="w-20 h-20 rounded-full border-4 border-white bg-white/20 flex items-center justify-center"><div className="w-16 h-16 bg-white rounded-full"></div></button>
                                </div>
                            </div>
                        )}

                        {/* VIEW: PROCESSING */}
                        {view === 'processing' && (
                            <div className="flex flex-col items-center justify-center h-[60vh] text-center space-y-6">
                                <div className="relative w-48 h-64 bg-gray-200 rounded-lg overflow-hidden shadow-xl mx-auto">
                                    {tempImage && <img src={tempImage} className="w-full h-full object-cover opacity-50 blur-sm" />}
                                    <div className="scan-line"></div>
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold">Analysiere Beleg...</h3>
                                    <p className="text-indigo-600">{statusText}</p>
                                </div>
                                <div className="w-64 bg-gray-200 rounded-full h-2">
                                    <div className="bg-indigo-600 h-2 rounded-full transition-all duration-300" style={{width: `${progress}%`}}></div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: EDIT / VALIDATE */}
                        {view === 'edit' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-8 duration-300">
                                <div className="bg-indigo-50 border border-indigo-100 rounded-xl p-4 flex gap-4 items-start">
                                    <div className="bg-white p-2 rounded border border-indigo-100 shadow-sm shrink-0">
                                        <Icons.Check className="w-6 h-6 text-green-500" />
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-indigo-900">Scan erfolgreich!</h3>
                                        <p className="text-sm text-indigo-700">Bitte überprüfe die Daten, bevor wir sie für die Buchhaltung speichern.</p>
                                    </div>
                                </div>

                                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-4">
                                    {/* Preview Image snippet */}
                                    <div className="h-24 w-full bg-gray-100 rounded-lg overflow-hidden mb-4 relative">
                                        <img src={tempImage} className="w-full h-full object-cover opacity-50 hover:opacity-100 transition cursor-pointer" title="Originalbild anzeigen" />
                                        <span className="absolute bottom-1 right-2 text-[10px] text-gray-500 bg-white/80 px-1 rounded">Bild-Vorschau</span>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Datum</label>
                                            <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Betrag (€)</label>
                                            <input type="number" step="0.01" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none font-bold text-gray-900" />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Händler / Geschäft</label>
                                        <input type="text" placeholder="z.B. REWE" value={formData.vendor} onChange={e => setFormData({...formData, vendor: e.target.value})} className="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none" />
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Kategorie</label>
                                            <select value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})} className="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:border-indigo-500 outline-none">
                                                <option>Büromaterial</option>
                                                <option>Reisekosten</option>
                                                <option>Bewirtung</option>
                                                <option>Wareneingang</option>
                                                <option>Sonstiges</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Steuersatz</label>
                                            <select value={formData.taxRate} onChange={e => setFormData({...formData, taxRate: parseInt(e.target.value)})} className="w-full p-2 bg-gray-50 border border-gray-300 rounded focus:border-indigo-500 outline-none">
                                                <option value="19">19% (Standard)</option>
                                                <option value="7">7% (Ermäßigt)</option>
                                                <option value="0">0% (Steuerfrei)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="pt-4 flex gap-3">
                                        <button onClick={() => setView('list')} className="flex-1 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg font-semibold transition">Abbrechen</button>
                                        <button onClick={saveEntry} className="flex-[2] py-3 text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold shadow-md transition">Eintrag speichern</button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
