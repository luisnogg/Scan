<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScanBill OCR</title>
    
    <!-- 1. Tailwind CSS für das Design laden -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React und ReactDOM laden -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel laden -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Tesseract.js für Texterkennung (OCR) laden -->
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #4f46e5;
            box-shadow: 0 0 4px #4f46e5;
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const React = window.React;
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {path}
            </svg>
        );

        const Icons = {
            Camera: (p) => <Icon {...p} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Refresh: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>} />,
            Check: (p) => <Icon {...p} path={<><polyline points="20 6 9 17 4 12"/></>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />
        };

        // --- HAUPTKOMPONENTE ---
        function App() {
            const [view, setView] = useState('start'); // 'start', 'camera', 'processing', 'result'
            const [image, setImage] = useState(null);
            const [progress, setProgress] = useState(0);
            const [statusText, setStatusText] = useState('');
            const [detectedAmount, setDetectedAmount] = useState(null);
            const [rawText, setRawText] = useState('');

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const streamRef = useRef(null);

            // Kamera Starten
            const startCamera = async () => {
                setView('camera');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    streamRef.current = stream;
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error("Kamera Fehler:", err);
                    alert("Kamera konnte nicht gestartet werden. Bitte Upload nutzen.");
                    setView('start');
                }
            };

            const stopCamera = () => {
                if (streamRef.current) {
                    streamRef.current.getTracks().forEach(track => track.stop());
                }
            };

            const capturePhoto = () => {
                if (videoRef.current && canvasRef.current) {
                    const video = videoRef.current;
                    const canvas = canvasRef.current;
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const photoDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    setImage(photoDataUrl);
                    stopCamera();
                    processImage(photoDataUrl);
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setImage(reader.result);
                        processImage(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // --- OCR LOGIK ---
            const processImage = async (imageData) => {
                setView('processing');
                setProgress(0);
                setStatusText('Lade OCR Engine...');

                try {
                    const result = await Tesseract.recognize(
                        imageData,
                        'deu', // Deutsch
                        {
                            logger: m => {
                                if (m.status === 'recognizing text') {
                                    setProgress(Math.round(m.progress * 100));
                                    setStatusText(`Analysiere Text: ${Math.round(m.progress * 100)}%`);
                                } else {
                                    setStatusText(m.status);
                                }
                            }
                        }
                    );

                    const text = result.data.text;
                    setRawText(text);
                    extractAmount(text);
                    setView('result');

                } catch (err) {
                    console.error(err);
                    setStatusText('Fehler bei der Erkennung');
                    alert("Fehler bei der Texterkennung.");
                    setView('start');
                }
            };

            // Versuche einen Preis zu finden
            const extractAmount = (text) => {
                // Regex für Formate wie: 12,99 | 12.99 | 100,00 € | EUR 5.00
                // Sucht nach Zahlen mit Komma/Punkt und 2 Dezimalstellen
                const priceRegex = /(\d+[.,]\d{2})/g;
                const matches = text.match(priceRegex);

                if (matches && matches.length > 0) {
                    // Oft ist der höchste Betrag auf dem Bon die Endsumme ("Total")
                    // Wir konvertieren alles zu Zahlen und nehmen das Maximum
                    const numbers = matches.map(m => parseFloat(m.replace(',', '.')));
                    const maxAmount = Math.max(...numbers);
                    setDetectedAmount(maxAmount.toFixed(2).replace('.', ','));
                } else {
                    setDetectedAmount(null);
                }
            };

            // Reset
            const reset = () => {
                setImage(null);
                setDetectedAmount(null);
                setRawText('');
                setProgress(0);
                setView('start');
            };

            // --- UI RENDER ---

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900 flex flex-col items-center">
                    
                    {/* Header */}
                    <div className="w-full bg-white shadow-sm p-4 sticky top-0 z-10 text-center">
                         <h1 className="text-xl font-bold text-gray-800 flex items-center justify-center gap-2">
                            <span className="bg-indigo-600 text-white p-1 rounded">OCR</span>
                            Rechnungs-Scanner
                        </h1>
                    </div>

                    <div className="flex-1 w-full max-w-md p-6 flex flex-col justify-center">
                        
                        {/* VIEW: START */}
                        {view === 'start' && (
                            <div className="space-y-6 animate-in fade-in zoom-in duration-300">
                                <div className="text-center space-y-2 mb-8">
                                    <div className="bg-indigo-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Icons.Search className="w-12 h-12 text-indigo-600" />
                                    </div>
                                    <h2 className="text-2xl font-bold text-gray-900">Beleg scannen</h2>
                                    <p className="text-gray-500">Fotografiere eine Rechnung, um den Betrag automatisch auszulesen.</p>
                                </div>

                                <button onClick={startCamera} className="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold shadow-lg shadow-indigo-200 flex items-center justify-center gap-3 transition transform active:scale-95">
                                    <Icons.Camera className="w-6 h-6" />
                                    Kamera starten
                                </button>

                                <div className="relative">
                                    <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-gray-300"></div></div>
                                    <div className="relative flex justify-center text-sm"><span className="px-2 bg-gray-50 text-gray-500">oder</span></div>
                                </div>

                                <label className="w-full py-4 bg-white border-2 border-dashed border-gray-300 hover:border-indigo-400 text-gray-600 rounded-xl font-medium cursor-pointer flex items-center justify-center gap-3 transition hover:bg-gray-50">
                                    <input type="file" accept="image/*" className="hidden" onChange={handleFileUpload} />
                                    <Icons.Upload className="w-6 h-6" />
                                    Bild hochladen
                                </label>
                            </div>
                        )}

                        {/* VIEW: CAMERA */}
                        {view === 'camera' && (
                            <div className="fixed inset-0 bg-black flex flex-col">
                                <video ref={videoRef} autoPlay playsInline className="flex-1 w-full object-cover" />
                                <canvas ref={canvasRef} className="hidden" />
                                <div className="p-8 flex justify-center gap-8 bg-black/80 backdrop-blur-sm">
                                    <button onClick={() => {stopCamera(); setView('start');}} className="p-4 rounded-full bg-gray-800 text-white hover:bg-gray-700"><Icons.X className="w-6 h-6" /></button>
                                    <button onClick={capturePhoto} className="w-20 h-20 rounded-full border-4 border-white bg-white/20 flex items-center justify-center hover:bg-white/40"><div className="w-16 h-16 bg-white rounded-full"></div></button>
                                </div>
                            </div>
                        )}

                        {/* VIEW: PROCESSING */}
                        {view === 'processing' && (
                            <div className="text-center space-y-6">
                                <div className="relative w-full aspect-[3/4] bg-gray-200 rounded-xl overflow-hidden shadow-inner">
                                    {image && <img src={image} className="w-full h-full object-contain opacity-50 blur-sm" />}
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                                    </div>
                                    <div className="scan-line"></div>
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-gray-800">Analysiere Bild...</h3>
                                    <p className="text-indigo-600 font-medium mt-1">{statusText}</p>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2.5">
                                    <div className="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style={{width: `${progress}%`}}></div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: RESULT */}
                        {view === 'result' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 text-center">
                                    <p className="text-sm text-gray-500 uppercase tracking-wide font-semibold mb-2">Erkannter Betrag</p>
                                    {detectedAmount ? (
                                        <div className="text-5xl font-extrabold text-indigo-600">
                                            {detectedAmount} <span className="text-2xl text-gray-400">€</span>
                                        </div>
                                    ) : (
                                        <div className="text-red-500 font-medium py-2">
                                            Kein eindeutiger Betrag gefunden.
                                        </div>
                                    )}
                                </div>

                                <div className="bg-gray-100 p-4 rounded-xl max-h-40 overflow-y-auto text-xs text-gray-500 font-mono border border-gray-200">
                                    <p className="font-bold mb-1 text-gray-700">Rohdaten (Auszug):</p>
                                    {rawText || "Kein Text erkannt"}
                                </div>

                                <div className="flex gap-4">
                                    <button onClick={reset} className="flex-1 py-3 bg-white border border-gray-300 text-gray-700 rounded-xl font-semibold shadow-sm hover:bg-gray-50 flex items-center justify-center gap-2">
                                        <Icons.Refresh className="w-5 h-5" />
                                        Neu scannen
                                    </button>
                                </div>
                                
                                <div className="relative w-full h-32 rounded-xl overflow-hidden border border-gray-200 opacity-80">
                                    <img src={image} className="w-full h-full object-cover" />
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
